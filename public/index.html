<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MGC Next</title>
  <link rel="stylesheet" href="/css/app-ui.css">
  
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-home" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3l9 8h-3v9h-4v-6H10v6H6v-9H3l9-8z"/></symbol>
    <symbol id="i-wand" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20l12-12 2 2L6 22H4v-2zM14 4l2-2 4 4-2 2-4-4z"/></symbol>
    <symbol id="i-info" viewBox="0 0 24 24"><path fill="currentColor" d="M11 7h2v2h-2V7zm0 4h2v6h-2v-6zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></symbol>
    <symbol id="i-map" viewBox="0 0 24 24"><path fill="currentColor" d="M15 6l6-2v14l-6 2-6-2-6 2V6l6-2 6 2zM9 6v12l6 2V8l-6-2z"/></symbol>
    <symbol id="i-user" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 10-5-5 5 5 0 005 5zm0 2c-5.33 0-8 2.67-8 6v2h16v-2c0-3.33-2.67-6-8-6z"/></symbol>
  </svg>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import './firebase-config.js'; // CI에서 생성됨 (레포에 커밋 X)

    const app = initializeApp(window.__FBCONFIG__);
    const auth = getAuth(app);
    // api.js 및 frame.js에서 사용할 수 있도록 전역으로 노출
    window.__FBAPP__ = { app, auth, GoogleAuthProvider, signInWithPopup, signOut };
  </script>
</head>
<body>
  <div class="app-wrap">
    <section id="auth-screen" class="app-center">
      <div class="card auth-card pad" style="text-align:center">
        <div style="font-size:20px; font-weight:800; margin-bottom:12px;">로그인</div>
        <div class="small" style="margin-bottom:20px;">Google로 로그인 후 이용해줘</div>
        <div id="login-button-anchor"></div>
      </div>
    </section>

    <section id="app-frame" class="app-center" style="display:none">
  <div data-view="home" style="display:none">
    <div class="hscroll"></div>
    <div class="section-h">추천 세계관</div>
    <div class="list" style="padding:0 16px 16px"></div>
  </div>

  <div data-view="create" style="display:none">
    <div class="section-h">무엇을 만들까요?</div>
    <div class="grid3"></div>
  </div>

  <div data-view="create-world" style="display:none">
    <div class="section-h">세계관 생성</div>
    <div class="card pad" style="margin:0 16px;">
      <div class="small" style="margin-bottom:6px">세계관 이름</div>
      <input type="text" id="world-create-name" placeholder="새로운 세계의 이름" style="margin-bottom:12px">
      <div class="small" style="margin-bottom:6px">추가 요청사항 (선택)</div>
      <textarea id="world-create-input" rows="4" placeholder="예: '사이버펑크와 동양 판타지를 섞어주세요'"></textarea>
      <button class="btn full" id="btn-world-generate-ai" style="margin-top:12px">AI로 세계관 생성</button>
      <div class="small" style="margin-top:8px; text-align:center;">* 브라우저에 저장된 Gemini 키로 AI를 호출합니다.</div>
    </div>
  </div>

  <div data-view="create-character" style="display:none">
      <div class="section-h">캐릭터 생성</div>
      <div class="card pad" style="margin:16px;">
        <input type="text" id="char-world" placeholder="worldId" style="margin-bottom:6px;">
        <div class="small" style="margin:6px 0">프롬프트 ID 또는 직접 프롬프트 중 하나만 입력</div>
        <input type="text" id="char-prompt" placeholder="promptId (선택)" style="margin-bottom:6px;">
        <textarea id="char-custom" rows="5" placeholder="직접 프롬프트 (선택)" style="margin-bottom:6px;"></textarea>
        <textarea id="char-input" rows="6" maxlength="1000" placeholder="사용자 입력(최대 1000자)" style="margin-bottom:8px;"></textarea>
        <button class="btn full" id="btn-char-create">생성</button>
      </div>
  </div>

  <div data-view="create-prompt" style="display:none">
    <div class="section-h">프롬프트 업로드</div>
    <div class="card pad" style="margin:16px;">
      <input type="text" id="p-title" placeholder="제목(최대 80자)" style="margin-bottom:6px;">
      <textarea id="p-content" rows="8" placeholder="프롬프트 내용" style="margin-bottom:8px;"></textarea>
      <button class="btn full" id="btn-prompt-upload">업로드</button>
      <div class="small" style="margin-top:12px;">* 검증 기능은 다음 업데이트에 추가될 예정입니다.</div>
    </div>
  </div>

  <div data-view="adventure" style="display:none">
    <div class="section-h">모험</div>
    <div class="list" style="padding:0 16px 16px"></div>
  </div>

  <div data-view="info" style="display:none">
    <div class="section-h">내 정보</div>
    <div class="card" style="margin:0 16px 12px">
      <div class="kv kv-uid"><div class="k">UID</div><div class="v small">-</div></div>
    </div>
    <div class="card pad" style="margin:0 16px 12px">
      <div class="small" style="margin-bottom:6px">Gemini API Key (브라우저 저장)</div>
      <input id="gemini-key" type="text" placeholder="AIza...">
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn" id="btn-save-key">저장</button>
        <button class="btn secondary" id="btn-logout">로그아웃</button>
      </div>
    </div>
  </div>

<div data-view="world-detail" style="display:none;">
  <div class="detail-header">
    <div class="grad"></div>
    <h2 class="shadow-title" id="world-detail-name"></h2>
  </div>

  <div class="detail-content">
    <div id="world-admin-panel" style="display:none; margin-bottom: 16px;">
      <button class="btn secondary full">콘텐츠 추가/수정</button>
    </div>

    <div class="detail-tabs-nav">
      <button class="tab-btn active" data-tab="intro">소개</button>
      <button class="tab-btn" data-tab="factions">세력</button>
      <button class="tab-btn" data-tab="npcs">주요 인물</button>
      <button class="tab-btn" data-tab="episodes">에피소드</button>
    </div>

    <div class="tab-content" id="tab-intro"></div>
    <div class="tab-content" id="tab-factions" style="display: none;"></div>
    <div class="tab-content" id="tab-npcs" style="display: none;"></div>
    <div class="tab-content" id="tab-episodes" style="display: none;"></div>
  </div>
</div>
<div data-view="episode-detail" style="display:none;"></div>
</section>

    <div id="bottom-bar">
      <div class="nav5">
        <button data-tab="home" class="active"><svg class="ico"><use href="#i-home"/></svg><div class="txt">홈</div></button>
        <button data-tab="create"><svg class="ico"><use href="#i-wand"/></svg><div class="txt">생성</div></button>
        <button data-tab="adventure"><svg class="ico"><use href="#i-map"/></svg><div class="txt">모험</div></button>
        <button data-tab="info"><svg class="ico"><use href="#i-user"/></svg><div class="txt">내정보</div></button>
      </div>
    </div>
  </div>

  <div id="ui-blocker"><div class="spinner"></div></div>

  <script type="module" src="/js/ui/frame.js"></script>
  
  <script>
    (function(){
      function initLoginButton(){
        const slot = document.getElementById('login-button-anchor');
        if (!slot) return;
        slot.innerHTML = '<button class="btn full" id="btn-login-google">Google로 로그인</button>';
        const btn = document.getElementById('btn-login-google');
        btn.addEventListener('click', async ()=>{
          try{
            const { auth, GoogleAuthProvider, signInWithPopup } = window.__FBAPP__ || {};
            if (!auth) return alert('Firebase 초기화가 필요해요.');
            await signInWithPopup(auth, new GoogleAuthProvider());
          }catch(e){ 
            if (e.code !== 'auth/popup-closed-by-user') alert(e.message||e); 
          }
        });
      }
      // DOM 로드 후 실행 보장
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLoginButton);
      } else {
        initLoginButton();
      }
    })();
  </script>
</body>
</html>
