<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MGC Next</title>
  <link rel="stylesheet" href="/css/app-ui.css">
  <link rel="stylesheet" href="/css/components.css"> <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-home" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3l9 8h-3v9h-4v-6H10v6H6v-9H3l9-8z"/></symbol>
    <symbol id="i-wand" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20l12-12 2 2L6 22H4v-2zM14 4l2-2 4 4-2 2-4-4z"/></symbol>
    <symbol id="i-info" viewBox="0 0 24 24"><path fill="currentColor" d="M11 7h2v2h-2V7zm0 4h2v6h-2v-6zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></symbol>
    <symbol id="i-map" viewBox="0 0 24 24"><path fill="currentColor" d="M15 6l6-2v14l-6 2-6-2-6 2V6l6-2 6 2zM9 6v12l6 2V8l-6-2z"/></symbol>
    <symbol id="i-user" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 10-5-5 5 5 0 005 5zm0 2c-5.33 0-8 2.67-8 6v2h16v-2c0-3.33-2.67-6-8-6z"/></symbol>
    <symbol id="i-trophy" viewBox="0 0 24 24"><path fill="currentColor" d="M18.8 3H5.2A2.2 2.2 0 0 0 3 5.2v.8A2.2 2.2 0 0 0 5.2 8.2h13.6A2.2 2.2 0 0 0 21 6v-.8A2.2 2.2 0 0 0 18.8 3M12 9c-2.8 0-5 2.2-5 5v5.5c0 1.4 1.1 2.5 2.5 2.5h5c1.4 0 2.5-1.1 2.5-2.5V14c0-2.8-2.2-5-5-5z"/></symbol>
  </svg>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import './firebase-config.js'; // CI에서 생성됨 (레포에 커밋 X)

    const app = initializeApp(window.__FBCONFIG__);
    const auth = getAuth(app);
    // api.js 및 frame.js에서 사용할 수 있도록 전역으로 노출
    window.__FBAPP__ = { app, auth, GoogleAuthProvider, signInWithPopup, signOut };
  </script>
</head>
<body>
  <div class="app-wrap">
    <section id="auth-screen" class="app-center">
      <div class="card auth-card pad" style="text-align:center">
        <div style="font-size:20px; font-weight:800; margin-bottom:12px;">로그인</div>
        <div class="small" style="margin-bottom:20px;">Google로 로그인 후 이용해줘</div>
        <div id="login-button-anchor"></div>
        <div class="small" style="margin-top:20px; font-size: 11px; line-height: 1.5;">
          로그인을 계속 진행할 경우, 서비스의
          <a href="/terms.html" target="_blank" style="color:var(--acc); text-decoration:none;">이용약관</a> 및
          <a href="/privacy.html" target="_blank" style="color:var(--acc); text-decoration:none;">개인정보 처리방침</a>에
          동의하는 것으로 간주합니다.
        </div>
      </div>
    </section>

    <section id="app-frame" class="app-center" style="display:none">
      <div data-view="home" style="display:none">
        <div class="hscroll"></div>
        <div class="section-h">추천 세계관</div>
        <div class="list" style="padding:0 16px 16px"></div>
      </div>

      <div data-view="create" style="display:none">
        <div class="section-h">무엇을 만들까요?</div>
        <div class="grid3"></div>
      </div>

      <div data-view="create-world" style="display:none">
        <div class="section-h">세계관 생성</div>
        <div class="card pad" style="margin:0 16px;">
          <div class="small" style="margin-bottom:6px">세계관 이름</div>
          <input type="text" id="world-create-name" placeholder="새로운 세계의 이름" style="margin-bottom:12px">
          <div class="small" style="margin-bottom:6px">추가 요청사항 (선택)</div>
          <textarea id="world-create-input" rows="4" placeholder="예: '사이버펑크와 동양 판타지를 섞어주세요'"></textarea>
          <button class="btn full" id="btn-world-generate-ai" style="margin-top:12px">AI로 세계관 생성</button>
          <div class="small" style="margin-top:8px; text-align:center;">* AI 호출을 위해 암호화된 API 키를 사용합니다.</div>
        </div>
      </div>

      <div data-view="create-character" style="display:none">
        <div id="cc-step1-world-selection">
          <div class="section-h">1. 생성할 캐릭터의 세계관 선택</div>
          <div style="padding: 0 16px 12px; display: flex; gap: 8px;">
            <input type="text" id="cc-world-search" placeholder="세계관 이름 검색..." style="flex-grow:1;">
          </div>
          <div class="list" id="cc-world-list" style="padding:0 16px 16px"></div>
        </div>

        <div id="cc-step2-prompt-selection" style="display:none;">
          <button class="btn secondary" id="cc-btn-back-to-step1" style="margin:16px 16px 0;">‹ 다른 세계관 선택</button>
          <div id="cc-selected-world-info" style="margin: 16px;"></div>
          <div class="section-h" style="padding-top:0;">2. 캐릭터 생성 프롬프트 선택</div>
          <div class="list" id="cc-prompt-list" style="padding:0 16px 16px"></div>
        </div>

        <div id="cc-step3-character-input" style="display:none;">
          <button class="btn secondary" id="cc-btn-back-to-step2" style="margin:16px 16px 0;">‹ 다른 프롬프트 선택</button>
          <div class="card pad" style="margin:16px;">
            <div class="small" style="margin-bottom:6px">캐릭터 이미지 (선택)</div>
            <input type="file" id="cc-char-image" accept="image/*" style="margin-bottom:12px; width:100%;">
            
            <div class="small" style="margin-bottom:6px">캐릭터 이름</div>
            <input type="text" id="cc-char-name" placeholder="새로운 캐릭터의 이름" style="margin-bottom:12px">

            <div class="small" style="margin-bottom:6px">추가 요청사항 (1000자 이하)</div>
            <textarea id="cc-char-input" rows="4" maxlength="1000" placeholder="예: '말수가 적고 신비로운 암살자 컨셉으로'"></textarea>
            
            <button class="btn full" id="btn-char-create-final" style="margin-top:12px">캐릭터 생성</button>
            <div class="small" style="margin-top:8px; text-align:center;">* AI 호출을 위해 암호화된 API 키를 사용합니다.</div>
          </div>
        </div>
      </div>

      <div data-view="create-prompt" style="display:none">
        <div class="section-h">프롬프트 업로드</div>
        <div class="card pad" style="margin:16px;">
          <input type="text" id="p-title" placeholder="제목(최대 80자)" style="margin-bottom:6px;">
          <textarea id="p-content" rows="8" placeholder="프롬프트 내용" style="margin-bottom:8px;"></textarea>
          <button class="btn full" id="btn-prompt-upload">업로드</button>
          <div class="small" style="margin-top:12px;">* 검증 기능은 다음 업데이트에 추가될 예정입니다.</div>
        </div>
      </div>
      
      <div data-view="create-site" style="display:none">
        <div class="section-h">명소 생성</div>
        <div class="card pad" style="margin:16px;">
          <div class="small" style="margin-bottom:6px">대상 세계관 ID</div>
          <input type="text" id="site-world-id" placeholder="명소를 추가할 World ID" style="margin-bottom:12px">

          <div class="small" style="margin-bottom:6px">명소 이름</div>
          <input type="text" id="site-name" placeholder="예: 그림자 폭포" style="margin-bottom:12px">

          <div class="small" style="margin-bottom:6px">명소 설명</div>
          <textarea id="site-description" rows="5" placeholder="이 장소의 역사, 특징, 위험 요소 등을 설명합니다."></textarea>

          <div class="small" style="margin:12px 0 6px">난이도</div>
          <select id="site-difficulty" class="select-box">
            <option value="easy">Easy</option>
            <option value="normal">Normal</option>
            <option value="hard">Hard</option>
            <option value="extreme">Extreme</option>
            <option value="impossible">Impossible</option>
          </select>
          
          <div class="small" style="margin:12px 0 6px">대표 이미지 (선택)</div>
          <input type="file" id="site-image" accept="image/*" style="width:100%;">

          <button class="btn full" id="btn-site-create" style="margin-top:12px">생성</button>
        </div>
      </div>

      <div data-view="adventure" style="display:none">
        <div class="section-h">모험</div>
        <div class="list" style="padding:0 16px 16px"></div>
      </div>

      <div data-view="matching" style="display:none"></div>
      <div data-view="battle" style="display:none"></div>
      <div data-view="ranking" style="display:none;">
        <div class="section-h">랭킹</div>
        <div class="list" style="padding:0 16px 16px"></div>
      </div>
      
      <div data-view="info" style="display:none">
        <div class="section-h">내 정보</div>
        <div class="card" style="margin:0 16px 12px">
          <div class="kv kv-uid"><div class="k">UID</div><div class="v small">-</div></div>
        </div>
        <div class="card pad" style="margin:0 16px 12px">
          <div class="small" style="margin-bottom:6px">Gemini API Key</div>
          <input id="gemini-key" type="password" placeholder="AIza..." style="margin-bottom:12px">
          
          <div class="small" style="margin-bottom:6px">암호화 비밀번호</div>
          <input id="gemini-key-password" type="password" placeholder="키를 암호화할 비밀번호" style="margin-bottom:12px">
        
          <div class="small" style="margin-bottom:6px">비밀번호 확인</div>
          <input id="gemini-key-password-confirm" type="password" placeholder="비밀번호 다시 입력">
        
          <div class="small" style="margin-top:12px; opacity: 0.8; line-height: 1.5;">
            * 입력한 키는 여기서 설정한 비밀번호로 암호화되어 서버에 저장됩니다. **이 비밀번호는 서버에 저장되지 않으므로, 절대 잊어버리지 마세요.**
          </div>
          
          <div style="display:flex; gap:8px; margin-top:16px">
            <button class="btn full" id="btn-save-key">저장 또는 갱신</button>
            <button class="btn secondary" id="btn-logout">로그아웃</button>
          </div>
        </div>
      </div>

      <div data-view="world-detail" style="display:none;"></div>
      
      <div data-view="episode-detail" style="display:none;"></div>
      <div data-view="character-detail" style="display:none;"></div>
    </section>

    <div id="bottom-bar">
      <div class="nav5">
        <button data-tab="home" class="active"><svg class="ico"><use href="#i-home"/></svg><div class="txt">홈</div></button>
        <button data-tab="create"><svg class="ico"><use href="#i-wand"/></svg><div class="txt">생성</div></button>
        <button data-tab="adventure"><svg class="ico"><use href="#i-map"/></svg><div class="txt">모험</div></button>
        <button data-tab="ranking"><svg class="ico"><use href="#i-trophy"/></svg><div class="txt">랭킹</div></button>
        <button data-tab="info"><svg class="ico"><use href="#i-user"/></svg><div class="txt">내정보</div></button>
      </div>
    </div>
  </div>

  <div id="ui-blocker"><div class="spinner"></div></div>

  <script type="module" src="/js/ui/frame.js"></script>
  <script>
    (function(){
      function initLoginButton(){
        const slot = document.getElementById('login-button-anchor');
        if (!slot) return;
        slot.innerHTML = '<button class="btn full" id="btn-login-google">Google로 로그인</button>';
        const btn = document.getElementById('btn-login-google');
        btn.addEventListener('click', async ()=>{
          try{
            const { auth, GoogleAuthProvider, signInWithPopup } = window.__FBAPP__ || {};
            if (!auth) return alert('Firebase 초기화가 필요해요.');
            await signInWithPopup(auth, new GoogleAuthProvider());
          }catch(e){ 
            if (e.code !== 'auth/popup-closed-by-user') alert(e.message||e); 
          }
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLoginButton);
      } else {
        initLoginButton();
      }
    })();
  </script>
</body>
</html>
